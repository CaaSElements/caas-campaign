<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`caas-campaign`
Campaign Data Element for Crowdfunding as a Service Solutions

@demo demo/index.html 
-->

<dom-module id="caas-campaign">
  <template>

    <iron-ajax
      id="getCampaignData"
      url="[[apiUrl]]"
      handle-as="json"
      method="GET"
      last-response="{{_apiData}}"
      debounce-duration="0"
      auto="[[apiUrl]]"
      headers="[[_requestHeaders]]"
    ></iron-ajax>

  </template>

  <script>
    Polymer({

      is: 'caas-campaign',

      properties: {

        apiEndpoint: {
          type: String
        },

        apiUrl: {
          type: String,
          computed: '_computeApiUrl(apiEndpoint, campaignId, accessToken)'
        },

        campaignId: {
          type: String
        },

        active: {
          type: Object,
          computed: '_computeActive(_apiData.status)',
          notify: true
        },

        thumbnailImageUrl: {
          type: String,
          computed: '_getApiDataValue(_apiData.thumb)',
          notify: true
        },

        imageUrl: {
          type: String,
          computed: '_getApiDataValue(_apiData.coverURL)',
          notify: true
        },

        imageUrls: {
          type: Array,
          computed: '_getApiDataValue(_apiData.coverURLsResponsive)',
          notify: true
        },

        title: {
          type: String,
          computed: '_getApiDataValue(_apiData.projectNaam)',
          notify: true
        },

        slug: {
          type: String,
          computed: '_getApiDataValue(_apiData.slug)',
          notify: true
        },

        proposition: {
          type: String,
          computed: '_getApiDataValue(_apiData.propositie)',
          notify: true
        },
        
        introductionText: {
          type: String,
          computed: '_getApiDataValue(_apiData.introductieTekst)',
          notify: true
        },

        bodyText: {
          type: String,
          computed: '_getApiDataValue(_apiData.interview)',
          notify: true
        },

        twitterUrl: {
          type: String,
          computed: '_computeTwitterUrl(_apiData.twitter)',
          notify: true
        },

        facebookUrl: {
          type: String,
          computed: '_computeFacebookUrl(_apiData.facebook)',
          notify: true
        },

        linkedInUrl: {
          type: String,
          computed: '_computeLinkedInUrl(_apiData.linkedin)',
          notify: true
        },

        categories: {
          type: Array,
          computed: '_getApiDataValue(_apiData.categories)',
          notify: true
        },

        video: {
          type: Object,
          computed: '_computeVideo(_apiData.video.*)',
          notify: true
        },

        address: {
          type: Object,
          computed: '_parseAddress(_apiData.address)',
          notify: true
        },

        geoLocation: {
          type: Object,
          computed: '_getApiDataValue(_apiData.geocode)',
          notify: true
        },

        contractTypes: {
          type: Object,
          computed: '_computeContractTypes(_apiData.contractTypeIds.*, _apiData.minInvestment, _apiData.maxInvestment, _apiData.maxInvestableForPrimaryContractType, _apiData.maxInvestableForSecondaryContractType, _apiData.maxInvestableForPrimaryContractType, _apiData.maxInvestableForSecondaryContractType, _apiData.investIncrements)',
          notify: true
        },

        accessToken: {
          type: String,
          value: null
        },

        _apiData: {
          type: Object,
          value: {}
        },

        _requestHeaders: {
          type: Object,
          computed: '_computeRequestHeaders(accessToken)'
        }

      },

      _computeRequestHeaders: function(accessToken) {
        if(!accessToken) return {};
        return {
          'authorization': 'Bearer ' + accessToken 
        }        
      },

      _computeApiUrl: function(apiEndpoint, campaignId, accessToken) {
        if(accessToken) {
          return apiEndpoint + '/entrepreneurs/' + campaignId;
        }
        return apiEndpoint + '/campaigns/' + campaignId;
      },

      _parseAddress: function(apiAddressData) {
        if(!apiAddressData) return {}
        return {
          street: apiAddressData.street,
          houseNumber: apiAddressData.houseNumber,
          postalCode: apiAddressData.postalCode,
          city: apiAddressData.city,
          region: apiAddressData.region,
          country: apiAddressData.country
        }
      },

      _computeTwitterUrl: function(twitterHandle) {
        if(!twitterHandle) return null;
        return 'https://twitter.com/' + twitterHandle;
      },

      _computeFacebookUrl: function(facebookHandle) {
        if(!facebookHandle) return null;
        return 'https://facebook.com/' + facebookHandle;
      },

      _computeLinkedInUrl: function(linkedInHandle) {
        if(!linkedInHandle) return null;
        return 'https://linkedin.com/' + linkedInHandle;
      },

      _computeContractTypes: function(contractTypeIdsSplice, minInvestment, maxInvestment, maxInvestableForPrimaryContractType, maxInvestableForSecondaryContractType, maxInvestableForPrimaryContractType, maxInvestableForSecondaryContractType, investIncrements) {
        var contractTypes = [];
        var contractTypeIds = contractTypeIdsSplice.base;
        if(contractTypeIds[0]) {
          contractTypes.push({
            id: contractTypeIds[0],
            smallestAllowedInvestment: this._getSmallestValue(minInvestment, maxInvestment, maxInvestableForPrimaryContractType, maxInvestableForPrimaryContractType),
            largestAllowedInvestment: this._getSmallestValue(maxInvestment, maxInvestableForPrimaryContractType, maxInvestableForPrimaryContractType),
            investmentStep: investIncrements
          })
        }
        if(contractTypeIds[1]) {
          contractTypes.push({
            id: contractTypeIds[1],
            smallestAllowedInvestment: this._getSmallestValue(minInvestment, maxInvestment, maxInvestableForSecondaryContractType, maxInvestableForSecondaryContractType),
            largestAllowedInvestment: this._getSmallestValue(maxInvestment, maxInvestableForSecondaryContractType, maxInvestableForSecondaryContractType),
            investmentStep: investIncrements
          })
        }
        return contractTypes;
      },

      _computeActive: function(apiDataStatus) {
        return (apiDataStatus == 1);
      },

      _computeVideo: function(apiDataVideoChange) {
        return apiDataVideoChange.base;
      },

      _getSmallestValue: function() {
        var values = Array.apply(null, arguments).sort(function(a, b) {
          return a - b;
        });
        return values[0];
      },

      _getApiDataValue: function(apiDataValue) {
        return apiDataValue;
      },

    });
  </script>
</dom-module>
